## UAVCAN Датчик воздушной скорости

Эта плата является преобразователем для [MS4525DO airspeed sensor](https://www.te.com/commerce/DocumentDelivery/DDEController?Action=showdoc&DocId=Data+Sheet%7FMS4525DO%7FB2%7Fpdf%7FEnglish%7FENG_DS_MS4525DO_B2.pdf%7FCAT-BLPS0002), который позволяет использовать его через сеть UAVCAN.

Плата считывает измерения с датчика через i2c и публикует температуру и дифференциальное давление.

![airspeed](airspeed.png?raw=true "airspeed")

## Содержание
  - [1. Интерфейс UAVCAN](#1-uavcan-interface)
  - [2. Спецификация оборудования](#2-hardware-specification)
  - [3. Подключение](#3-wire)
  - [4. Описание основных функций](#4-main-function-description)
  - [5. Описание вспомогательных функций](#5-auxiliary-function-description)
  - [6. Параметры](#6-parameters)
  - [7. Светодиодная индикация](#7-led-indication)
  - [8. Пример использования на стенде](#8-usage-example-on-a-table)
  - [9. Пример использования в БПЛА](#9-uav-usage-example)

## 1. Интерфейс UAVCAN <a name="1-uavcan-interface"></a> 

Этот узел взаимодействует посредством следующих сообщений:

| № | тип | сообщение |
| - | --------- | -------- |
| 1 | publisher | [uavcan.equipment.air_data.RawAirData](https://legacy.uavcan.org/Specification/7._List_of_standard_data_types/#rawairdata) |
| 2 | publisher | [uavcan.equipment.power.CircuitStatus](https://legacy.uavcan.org/Specification/7._List_of_standard_data_types/#circuitstatus) |

Помимо необходимых и очень рекомендуемых функций, таких как `NodeStatus` и `GetNodeInfo`, этот узел также поддерживает следующие функции прикладного уровня:

| № | тип | сообщение |
| - | --------- | -------- |
| 1 | service consumer | [uavcan.protocol.param](https://legacy.uavcan.org/Specification/7._List_of_standard_data_types/#uavcanprotocolparam)|
| 2 | service consumer | [uavcan.protocol.RestartNode](https://legacy.uavcan.org/Specification/7._List_of_standard_data_types/#restartnode)|
| 3 | service consumer | [uavcan.protocol.GetTransportStats](https://legacy.uavcan.org/Specification/7._List_of_standard_data_types/#gettransportstats) |

## 2. Спецификация оборудования <a name="2-hardware-specification"></a> 

![airspeed_scheme](airspeed_scheme.jpg?raw=true "airspeed_scheme")

## 3. Подключение <a name="3-wire"></a> 

Вы можете запитать эту плату, используя один из 2 CAN-разъемов:

1. UCANPHY Micro (JST-GH 4).
```
Примечание спецификации физического уровня UAVCAN/CAN.
Устройства, подающие питание на шину, должны обеспечивать 4,9-5,5 В на линии питания шины, номинальное напряжение 5,0 В.
Устройства, получающие питание от шины, должны ожидать 4,0-5,5 В на линии питания шины. Ток не должен
превышать 1 А на каждый разъем.
```
2. 6-контактный разъем Molex серии 502585 ([502585-0670](https://www.molex.com/molex/products/part-detail/pcb_receptacles/5025850670) и [502578-0600](https://www.molex.com/molex/products/part-detail/crimp_housings/5025780600))

```
До 100 В, 2 A на контакт
```

Он также имеет разъем SWD, предназначенный для обновления прошивки с помощью устройства [programmer-sniffer](doc/programmer_sniffer/README.md).

## 4. Описание основных функций <a name="4-main-function-description"></a> 

Этот узел измеряет дифференциальное давление и температуру с высокой скоростью (100 Гц по умолчанию) и публикует усредненные данные с низкой скоростью (10 Гц должно быть достаточно для автопилота PX4, иначе он в любом случае будет выполнять усреднение). Скорость публикации и измерений можно настроить с помощью параметров узла, но рекомендуется использовать значения по умолчанию.

Согласно `ms452525do datasheet` этот узел имеет следующий диапазон измеряемых данных:
- дифференциальное давление от -1 psi до +1 psi или от -6894.757 pa до +6894.757 pa.
- температура от -50 до +150 градусов Цельсия или от 223 до 423 Кельвинов.

Если учесть температуру ~288 Кельвин и давление 101325 Па, то согласно модели ISA интервал перепада давления должен быть достаточным для скорости до 100 м/с, что подходит для широкой области применения малого VTOL.


## 5. Описание вспомогательных функций <a name="5-auxiliary-function-description"></a> 

**Состояние цепи**.

Плата также посылает сообщения [uavcan.equipment.power.CircuitStatus](https://legacy.uavcan.org/Specification/7._List_of_standard_data_types/#circuitstatus) с измеренными `5V` и `Vin`.

**Калибровка**

При установке параметра `airspeed_calib_request` в 1 узел переходит в режим калибровки на 10 секунд, где суммирует все измеренные дифференциальные давления и в конце делит сумму на количество измерений. Полученное отрицательное усредненное значение записывается в параметр `airspeed_calibration_offset`. Это смещение добавляется к дифференциальному давлению каждого измерения. Во время процесса калибровки узел находится в режиме `INITIALIZATION`. После процесса инициализации узел не сохраняет параметры в памяти flash, вам необходимо сделать это вручную.
В качестве альтернативы, вы всегда можете вручную установить параметр `airspeed_calibration_offset`.

```
Примечание. Использование параметров для запуска процесса калибровки, конечно, не лучшее решение. Но это единственный способ запустить его со стороны QGC. Текущий PX4 поддерживает только централизованную калибровку на стороне автопилота.
```

**Включить/выключить**.
Обычно эта функция не нужна. Но она позволяет вам начинать и прекращать публикацию через UAVCAN в реальном времени без физического отключения.

**Версия программного обеспечения**.

Ответ GetNodeInfo содержит версию программного обеспечения, которая позволяет отличить одну прошивку от другой. См. окно `Node Properties` в утилите `uavcan gui`.

**Версия аппаратного обеспечения**.

Пока не реализовано.

**Уникальный идентификатор аппаратного обеспечения**

Ответ GetNodeInfo содержит уникальный ID оборудования, который позволяет отличить одну плату от другой. См. окно `Свойства узла` в `uavcan gui tool`.


## 6. Параметры <a name="6-parameters"></a> 

Список доступных параметров показан на рисунке ниже:

![схема](airspeed_params.png?raw=true "схема")

| № | Имя параметра | Описание |
| - | ------------ | ----------- |
| 0 | ID | Вы должны вручную выбрать ID узла. На шине не должно существовать несколько узлов с одинаковым ID. |
| 1 | airspeed_enable | 0 - запретить публикацию данных, 1 - разрешить |
| 2 | airspeed_pub_period | Период публикации сообщений.
| 3 | airspeed_measurement_period | Период измерения данных |
| 4 | airspeed_calibration_offset | Публикуемый перепад давления = измеренное давление + это смещение |
| 5 | airspeed_calibration_request | Запрос на автоматическую калибровку. Подробности см. в описании этой функции. |
| 6 | enable_5v_check | Установить статус ERROR, если напряжение 5 В выходит за пределы диапазона 4,5 - 5,5 В |
| 7 | enable_vin_check | Установите статус ERROR, если напряжение Vin меньше 4,5 В |
| 8 | name | Если указанное значение != 0, используйте пользовательское имя узла. Пока пользовательских имен нет, но они могут быть расширены, если вам это необходимо. |
| 9 | live_minutes | Пока не реализовано. |

## 7. Светодиодная индикация <a name="7-led-indication"></a> 

Имеется внутренний светодиодный индикатор, который может позволить вам понять возможные проблемы. Он мигает от 1 до 10 раз в течение 4 секунд. Подсчитав количество миганий, вы можете определить текущее состояние узла.

| Количество миганий | Состояние | Описание | 
| ---------------- | -------------- | ------------------------------- |
| 1 | OK | Все в порядке.                |
| 2 | OK | Нет RawCommand, по крайней мере, за последние 0,5 секунды (это нормально, на всякий случай). |
| 3 | ПРЕДУПРЕЖДЕНИЕ | Этот узел не видит другие узлы в сети UAVCAN, проверьте кабели. |
| 4 | ОШИБКА | Проблема с напряжением в цепи, подробности смотрите в сообщении о состоянии цепи. Это может произойти при питании от SWD, так как напряжение составляет всего 3,3 В, в противном случае будьте осторожны с питанием. Эта проверка может быть отключена с помощью параметров. |
| 5 | CRITICAL | Есть проблема на уровне инициализации периферии. Возможно, вы загрузили неправильную прошивку. |


## 8. Пример использования на стенде <a name="8-usage-example-on-a-table"></a> 

Вы можете сначала попробовать это устройство на стенде, используя [uavcan_gui_tool](https://github.com/UAVCAN/gui_tool). Вы можете проверить сообщение, отправленное этим узлом.

Здесь приведен пример сообщения, когда устройство находится на столе и нет ветра.

![схема](airspeed_message.png?raw=true "схема")

График, созданный в тех же условиях:

![airspeed_plot](airspeed_plot.png?raw=true "airspeed_plot")

Здесь у нас есть смещение в измерениях. Оно может быть откорректировано в результате калибровки.

## 9. Пример использования БПЛА <a name="9-uav-usage-example"></a> 

Этот узел был много раз протестирован на VTOL-самолете.

**Настройка параметров PX4 перед использованием**.

Обычно, чтобы использовать узел с автопилотом на базе PX4, необходимо установить следующие параметры:
- `UAVCAN_ENABLE`,
- `UAVCAN_SUB_ASPD` (начиная с версии 1.13.1).
Также рекомендуется настроить `ASPD_DO_CHECKS`.

**Настройка параметров узла с помощью QGC**

На данный момент лучшим способом настройки параметров узла является использование `MAVLing console`.

Набрав `uavcan status` в консоли MAVLink, вы сможете увидеть это устройство.

Для выполнения калибровки на стороне датчика из QGC необходимо ввести:
1. `uavcan param list 74` - проверить, поддерживается ли функция калибровки.
2. `uavcan param set 74 airspeed_calib_request 1` - запустить калибровку.
3. `uavcan param save 74` - сохранить новые параметры калибровки.

![airspeed_qgc](airspeed_qgc.png?raw=true "airspeed_qgc")

Здесь 74 - это идентификатор нашего узла. Он имеет калибровочное смещение -69.

После этого узел готов к использованию.

**Пример журнала полета**

Здесь вы можете увидеть скриншот из журнала реального полета в режиме FW.

![px4_log_airspeed_2021_11_12](px4_log_airspeed_2021_11_12.png?raw=true "px4_log_airspeed_2021_11_12")

