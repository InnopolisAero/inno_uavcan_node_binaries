## UAVCAN Датчик воздушной скорости

Эта плата является адаптером для [датчика дифференциального давления MS4525DO](https://www.te.com/commerce/DocumentDelivery/DDEController?Action=showdoc&DocId=Data+Sheet%7FMS4525DO%7FB2%7Fpdf%7FEnglish%7FENG_DS_MS4525DO_B2.pdf%7FCAT-BLPS0002), который позволяет использовать его через сеть UAVCAN.

Плата считывает измерения с датчика через i2c и публикует температуру и дифференциальное давление.

![airspeed](airspeed.png?raw=true "airspeed")

## Содержание
  - [1. Интерфейс UAVCAN](#1-uavcan-interface)
  - [2. Спецификация оборудования](#2-hardware-specification)
  - [3. Подключение](#3-wire)
  - [4. Описание основных функций](#4-main-function-description)
  - [5. Описание вспомогательных функций](#5-auxiliary-function-description)
  - [6. Параметры](#6-parameters)
  - [7. Светодиодная индикация](#7-led-indication)
  - [8. Пример использования на стенде](#8-usage-example-on-a-table)
  - [9. Пример использования в БПЛА](#9-uav-usage-example)

## 1. Интерфейс UAVCAN <a name="1-uavcan-interface"></a> 

Узел отправляет следующие сообщения с постоянной частотой:

| № | тип | сообщение |
| - | --------- | -------- |
| 1 | publisher | [uavcan.equipment.air_data.RawAirData](https://dronecan.github.io/Specification/7._List_of_standard_data_types/#rawairdata) |
| 2 | publisher | [uavcan.equipment.power.CircuitStatus](https://dronecan.github.io/Specification/7._List_of_standard_data_types/#circuitstatus) |

Помимо необходимых и очень рекомендуемых функций, таких как `NodeStatus` и `GetNodeInfo`, узел также поддерживает следующие функции прикладного уровня:

| № | тип | сообщение |
| - | --------- | -------- |
| 1 | RPC-service | [uavcan.protocol.param](https://dronecan.github.io/Specification/7._List_of_standard_data_types/#uavcanprotocolparam)|
| 2 | RPC-service | [uavcan.protocol.RestartNode](https://dronecan.github.io/Specification/7._List_of_standard_data_types/#restartnode)|
| 3 | RPC-service | [uavcan.protocol.GetTransportStats](https://dronecan.github.io/Specification/7._List_of_standard_data_types/#gettransportstats) |

## 2. Спецификация оборудования <a name="2-hardware-specification"></a> 

![airspeed_scheme](airspeed_scheme.jpg?raw=true "airspeed_scheme")

## 3. Подключение <a name="3-wire"></a> 

Плата имеет 3 разъема, описание которых приведено в таблице ниже.

| № | Разъем | Описание |
| - | --------- | ----------- |
| 1 | UCANPHY Micro (JST-GH 4) | Устройства, подающие питание на шину, должны обеспечивать 4,9-5,5 В на линии питания шины, номинальное напряжение 5,0 В. Устройства, получающие питание от шины, должны ожидать 4,0-5,5 В на линии питания шины. Ток не должен превышать 1 А на каждый разъем. |
| 2 | 6-контактный Molex ([502585-0670](https://www.molex.com/molex/products/part-detail/pcb_receptacles/5025850670), [502578-0600](https://www.molex.com/molex/products/part-detail/crimp_housings/5025780600)) | Разъем поддерживает дДо 100 В, 2 A на контакт, но DC-DC на плате до 60В. Мы рекомендуем использовать до 30 В на линии. |
| 3 | SWD | Обновление прошивки STM32 с помощью [programmer-sniffer](doc/programmer_sniffer/README.md). |

## 4. Описание основных функций <a name="4-main-function-description"></a> 

Узел измеряет дифференциальное давление и температуру с высокой частотой (100 Гц по умолчанию) и публикует усредненные данные с низкой частотой (10 Гц должно быть достаточно для автопилота PX4, т.к. он все равно сам усредняет их до 10 Гц). Скорость публикации и измерений можно настроить с помощью параметров узла, но рекомендуется использовать значения по умолчанию.

Согласно [MS4525DO datasheet](https://www.te.com/commerce/DocumentDelivery/DDEController?Action=showdoc&DocId=Data+Sheet%7FMS4525DO%7FB2%7Fpdf%7FEnglish%7FENG_DS_MS4525DO_B2.pdf%7FCAT-BLPS0002) датчик имеет следующий диапазон измеряемых данных:
- дифференциальное давление от -1 psi до +1 psi или от -6894.757 pa до +6894.757 pa.
- температура от -50 до +150 градусов Цельсия или от 223 до 423 Кельвинов.

Если считать, что температура ~288 Кельвин и давление 101325 Па, то, согласно модели ISA, интервал перепада давления должен быть достаточным для скорости до 100 м/с, что подходит для широкой области применения малого VTOL.


## 5. Описание вспомогательных функций <a name="5-auxiliary-function-description"></a> 

**Состояние цепи**.

Плата посылает сообщения [uavcan.equipment.power.CircuitStatus](https://dronecan.github.io/Specification/7._List_of_standard_data_types/#circuitstatus) с измеренными `5V` и `Vin`.

У первого сообщения с `circuit_id=NODE_ID*10 + 0` следующие 2 поля:
1. voltage -  `5V` напряжение,
2. error_flags - может иметь флаги `ERROR_FLAG_OVERVOLTAGE`, `ERROR_FLAG_UNDERVOLTAGE`, либо ни один из них.

У второго сообщения с `circuit_id=NODE_ID*10 + 1` следующие 2 поля:
1. voltage - `Vin` напряжение,
2. error_flags - может иметь флаг `ERROR_FLAG_UNDERVOLTAGE`.

**Калибровка**

При установке значения параметра `airspeed_calib_request` в 1 узел переходит в режим калибровки на 10 секунд, где суммирует все измеренные дифференциальные давления и в конце делит сумму на количество измерений. Полученное отрицательное усредненное значение записывается в параметр `airspeed_calibration_offset`. Это смещение добавляется к дифференциальному давлению каждого измерения. Во время процесса калибровки узел находится в режиме `INITIALIZATION`. После процесса инициализации узел не сохраняет параметры в памяти flash, вам необходимо сделать это вручную.
В качестве альтернативы, вы всегда можете вручную установить параметр `airspeed_calibration_offset`.

```
Примечание. Использование параметров для запуска процесса калибровки, конечно, не лучшее решение. Но это единственный способ запустить его со стороны QGC. Текущий PX4 поддерживает только централизованную калибровку на стороне автопилота.
```

**Включить/выключить**.
Функция позволяет вам начинать и прекращать публикацию измеренных данных по UAVCAN в реальном времени без физического отключения.

**Версия программного обеспечения**.

Ответ GetNodeInfo содержит версию программного обеспечения, которая позволяет отличить одну прошивку от другой. См. окно `Node Properties` в утилите `uavcan gui tool`.

**Версия аппаратного обеспечения**.

Пока не реализовано.

**Уникальный идентификатор аппаратного обеспечения**

Ответ `GetNodeInfo` содержит уникальный ID оборудования, который позволяет отличить одну плату от другой. См. окно `Node Properties` в `uavcan gui tool`.


## 6. Параметры <a name="6-parameters"></a> 

Список доступных параметров показан на рисунке ниже:

![Node Propertis](airspeed_params.png?raw=true "Node Propertis")


| № | Имя параметра | Описание |
| - | ------------ | ----------- |
| 0 | ID | Вы должны вручную выбрать ID узла. На шине не должно существовать несколько узлов с одинаковым ID. |
| 1 | airspeed_enable | 0 - запретить публикацию данных, 1 - разрешить |
| 2 | airspeed_pub_period | Период публикации сообщений.
| 3 | airspeed_measurement_period | Период измерения данных |
| 4 | airspeed_calibration_offset | Публикуемый перепад давления = измеренное давление + это смещение |
| 5 | airspeed_calibration_request | Запрос на автоматическую калибровку. Подробности см. в описании этой функции. |
| 6 | enable_5v_check | Установить статус ERROR, если напряжение 5 В выходит за пределы диапазона 4,5 - 5,5 В |
| 7 | enable_vin_check | Установите статус ERROR, если напряжение Vin меньше 4,5 В |
| 8 | name | Если указанное значение != 0, используйте пользовательское имя узла. Пока пользовательских имен нет, но они могут быть расширены, если вам это необходимо. |

## 7. Светодиодная индикация <a name="7-led-indication"></a> 

Имеется внутренний светодиодный индикатор, который может позволить вам понять возможные проблемы. Он мигает от 1 до 10 раз в течение 4 секунд. Подсчитав количество миганий, вы можете определить текущее состояние узла.

| Количество миганий | Uavcan health | Описание |
| ---------------- | -------------- | ------------------------------- |
| 1 | OK | Все в порядке.                |
| 2 | OK | Нет RawCommand, по крайней мере, за последние 0,5 секунды (это нормально, на всякий случай). |
| 3 | WARNING | Этот узел не видит другие узлы в сети UAVCAN, проверьте кабели. |
| 4 | ERROR | Проблема с напряжением в цепи, подробности смотрите в сообщении о состоянии цепи. Это может произойти при питании от SWD, так как напряжение составляет всего 3,3 В, в противном случае будьте осторожны с питанием. Эта проверка может быть отключена с помощью параметров. |
| 5 | CRITICAL | Есть проблема на уровне инициализации периферии. Возможно, вы загрузили неправильную прошивку. |


## 8. Пример использования на столе <a name="8-usage-example-on-a-table"></a> 

Вы можете сначала попробовать устройство на стенде, используя [uavcan_gui_tool](https://github.com/UAVCAN/gui_tool). Вы можете проверить сообщение, отправленное узлом.

Здесь приведен пример сообщения, когда устройство находится на столе и нет ветра.

![схема](airspeed_message.png?raw=true "схема")

График, созданный в тех же условиях:

![airspeed_plot](airspeed_plot.png?raw=true "airspeed_plot")

Смещение в измерениях может быть откорректировано в результате калибровки.

## 9. Пример использования БПЛА <a name="9-uav-usage-example"></a> 

Узел был много раз протестирован на VTOL'е.

**Настройка параметров PX4 перед использованием**.

Обычно, чтобы использовать узел с автопилотом на базе PX4, необходимо установить следующие параметры:
- `UAVCAN_ENABLE`,
- `UAVCAN_SUB_ASPD` (начиная с версии 1.13.1).
- Также рекомендуется настроить `ASPD_DO_CHECKS`.

**Настройка параметров узла с помощью QGC**

На данный момент лучшим способом настройки параметров узла является использование `MAVLink console`.

Набрав `uavcan status` в консоли MAVLink, вы сможете увидеть это устройство.

Для выполнения калибровки на стороне датчика из QGC необходимо ввести:
1. `uavcan param list 74` - проверить, поддерживается ли функция калибровки.
2. `uavcan param set 74 airspeed_calib_request 1` - запустить калибровку.
3. `uavcan param save 74` - сохранить новые параметры калибровки.

![airspeed_qgc](airspeed_qgc.png?raw=true "airspeed_qgc")

Здесь 74 - это идентификатор нашего узла. Он имеет калибровочное смещение -69.

После этого узел готов к использованию.

**Пример журнала полета**

Ниже представлен скриншот из журнала реального полета в режиме FW (px4 flight review).

![px4_log_airspeed_2021_11_12](px4_log_airspeed_2021_11_12.png?raw=true "px4_log_airspeed_2021_11_12")

