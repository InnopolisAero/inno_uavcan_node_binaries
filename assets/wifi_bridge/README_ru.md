## Узел UAVCAN WiFi Sniffer

WiFi Sniffer представляет из себя мост между UAVCAN/CAN и UDP/WiFi.

Устройство предназначено для беспроводного анализа сетей UAVCAN. Оно устанавливает соединение между CAN-сетью с помощью одного из 2 разъемов CAN с одной стороны и указанной WiFi сетью через UDP с другой стороны.
Может использоваться, как более безопасная альтернатива [проводному UAVCAN снифферу](https://github.com/InnopolisAero/inno_uavcan_node_binaries/blob/master/docs/guide/programmer_sniffer/README_ru.md).

На данный момент есть 2 версии платы. Они проиллюстрированы ниже.

Версия 1.0                 | Версия 2.0
:-------------------------:|:-------------------------:
![wifi_board_v1](wifi_board_v1.png?raw=true)  |  ![wifi_board_v2](wifi_board_v2.png?raw=true)

Вторая версия платы дешевле и меньше, чем первая. Вместо USB type-C у нее UART.

## Содержание
  - [1. Интерфейс UAVCAN](#1-uavcan-interface)
  - [2. Спецификация оборудования](#2-hardware-specification)
  - [3. Подключение](#3-wire)
  - [4. Описание основных функций](#4-main-function-description)
  - [5. Описание вспомогательных функций](#5-auxiliary-function-description)
  - [6. Параметры](#6-parameters)
  - [7. Светодиодная индикация](#7-led-indication)
  - [8. Пример использования на стенде](#8-usage-example-on-a-table)
  - [9. Пример использования с БПЛА](#9-uav-usage-example)
  - [10. Тесты производительности](#10-performance-tests)


## 1. Интерфейс UAVCAN <a name="1-uavcan-interface"></a> 

Узел не отправляет никаких собственных сообщений и подписывается на все сообщения на шине.

Помимо необходимых и очень рекомендуемых функций, таких как `NodeStatus` и `GetNodeInfo`, узел также поддерживает следующие функции прикладного уровня:

| № | тип | сообщение |
| - | --------- | -------- |
| 1 | RPC-service | [uavcan.protocol.param](https://dronecan.github.io/Specification/7._List_of_standard_data_types/#uavcanprotocolparam) |
| 2 | RPC-service | [uavcan.protocol.RestartNode](https://dronecan.github.io/Specification/7._List_of_standard_data_types/#restartnode) |
| 3 | RPC-service | [uavcan.protocol.GetTransportStats](https://dronecan.github.io/Specification/7._List_of_standard_data_types/#gettransportstats) |

## 2. Спецификация оборудования <a name="2-hardware-specification"></a> 

Схема платы v2.0 представлена ниже.

![scheme_v2](scheme_v2.png?raw=true)

## 3. Подключение <a name="3-wire"></a> 

Плата имеет 4 разъема, описание которых приведено в таблице ниже.

| № | Разъем | Описание |
| - | --------- | ----------- |
| 1 | UCANPHY Micro (JST-GH 4) | Устройства, подающие питание на шину, должны обеспечивать 4,9-5,5 В на линии питания шины, номинальное напряжение 5,0 В. Устройства, получающие питание от шины, должны ожидать 4,0-5,5 В на линии питания шины. Ток не должен превышать 1 А на каждый разъем. |
| 2 | 6-контактный Molex ([502585-0670](https://www.molex.com/molex/products/part-detail/pcb_receptacles/5025850670), [502578-0600](https://www.molex.com/molex/products/part-detail/crimp_housings/5025780600)) | Разъем поддерживает до 100 В, 2 A на контакт, но плата работает только с 2S-6S. |
| 3 | SWD | Обновление прошивки STM32 с помощью [programmer-sniffer](docs/guide/programmer_sniffer/README.md). |
| 4 | Разъем esp8266 | Обновление прошивки Esp8266 с помощью преобразователя usb-uart. |


## 4. Описание основных функций <a name="4-main-function-description"></a> 

Узел подходит для удаленной конфигурации узлов сети UAVCAN или анализа/регистрации потока данных.

```
Примечание: Из-за ограничения производительности узел не подходит для приложений, требующих быстрого отклика, таких как управление двигателями.
```

![params](params.png?raw=true "params")

## 5. Описание вспомогательных функций <a name="5-auxiliary-function-description"></a> 

**Версия программного обеспечения**

Ответ GetNodeInfo содержит версию программного обеспечения, которая позволяет отличить одну прошивку от другой. См. окно `Свойства узла` в `uavcan gui tool`.

**Версия аппаратного обеспечения**.

Пока не реализовано.

**Уникальный идентификатор аппаратного обеспечения**

Ответ GetNodeInfo содержит уникальный ID оборудования, который позволяет отличить одну плату от другой. См. окно `Свойства узла` в `uavcan gui tool`.

**Перезагрузка**

Отправив запрос [uavcan.protocol.RestartNode](https://dronecan.github.io/Specification/7._List_of_standard_data_types/#restartnode), данный узел может быть перезапущен.

**GetTransportStats**.

При отправке запроса [uavcan.protocol.GetTransportStats](https://dronecan.github.io/Specification/7._List_of_standard_data_types/#gettransportstats) данный узел ответит сообщением с количеством переданных и принятых кадров.

## 6. Параметры

![params](params.png?raw=true "params")

## 7. Светодиодная индикация <a name="7-led-indication"></a> 

Плата имеет 2 светодиода. Один из них предназначен для индикации состония микроконтроллера STM32, другой - для EPS8266.

Оба светодиода позволяют понять возможные проблемы. Они мигают от 1 до 5 раз в течение 2 секунд, а затем ждут 2 секунды. Подсчитав количество миганий, можно определить код текущего состояния.

Значение миганий светодиода STM32:

| Количество миганий | Состояние | Описание |
| ---------------- | -------------- | ------------------------------- |
| 1 | OK | UART и CAN принимают и работают.
| 2 | ПРЕДУПРЕЖДЕНИЕ | Нет данных RX от UART |
| 3 | ПРЕДУПРЕЖДЕНИЕ | Нет данных RX от CAN | 
| 4 | ПРЕДУПРЕЖДЕНИЕ | Нет данных RX вообще |
| 5 | CRITICAL | Проблема на уровне инициализации периферии. Возможно, вы загрузили неправильную прошивку. |

## 8. Пример использования на стенде <a name="8-usage-example-on-a-table"></a> 

Ниже приведен пример графика монитора шины с подключенным устройством, которое было опубликовано с частотой кадров 1500 кадров в секунду. 

![frames_rate_1500.png](frames_rate_1500.png?raw=true "frames_rate_1500.png")

## 9. Пример использования БПЛА <a name="9-uav-usage-example"></a> 

WiFi сниффер был протестирован несколько раз со сложными VTOL и другими приложениями.

![uav_example.png](uav_example.png?raw=true "uav_example.png")

## 10. Тесты производительности <a name="10-performance-tests"></a> 

Плата имеет следующие характеристики производительности:
- Время отклика до 1 мс для каждого клиента WiFi.
- Максимальная пропускная способность - 3703 кадра в секунду.

```
Время отклика ограничено временем, необходимым ESP8266 для отправки UDP пакета.
Пропускная способность ограничена частотой uart, которая составляет 1000000 бит/сек. Согласно SLCAN каждый CAN кадр кодируется в 27 байт. Таким образом, максимальная скорость передачи кадров составляет 3703 кадра в секунду.
```

## 11. Обновление прошивки <a name="11-how-to-upload-firmware"></a>

1. Прошивка STM32 обновляется через разъем SWD

2. Прошивка ESP8266 обновляется через разъемUART

Параметры обеих версий плат, актуальные при загрузке прошивки, представлены ниже.

| № | Параметр                | v1.0      | v2.0    |
| - | ----------------------- | --------- | ------- |
| 1 | Tools/Crystal Frequency | 26 MHz    | 40 MHz  |
