# UAVCAN узел двигателя внутреннего сгорания

Эта плата предназначена для управления двигателем внутреннего сгорания, таким как [DLE-20](http://rcstv.ru/static/fileunit/107b61373aea5dbedd58c2029d3c781fe909c3d9/DLE%2020%20Hobbico%20Manual%20Best.pdf).

Она отображает определенные каналы сообщений [RawCommand](https://dronecan.github.io/Specification/7._List_of_standard_data_types/#rawcommand) в 3 управляющих сигнала:
1. ШИМ дроссельной заслонки (частота 50 Гц и длительность от 900 до 2000),
2. Выходной пин GPIO зажигания.
3. Выходной контакт GPIO стартера.

Плата возвращает [uavcan.equipment.ice.reciprocating.Status](https://dronecan.github.io/Specification/7._List_of_standard_data_types/#status-4) с оборотами и состоянием двигателя и [uavcan.equipment.ice.FuelTankStatus](https://dronecan.github.io/Specification/7._List_of_standard_data_types/#fueltankstatus) с уровнем топлива в баке на основе:
1. Датчик оборотов (датчик Холла, таймер),
2. датчик топливного бака (MS4525DO, i2c).

![starter](starter.png?raw=true "starter")

## Содержание

  - [1. Интерфейс UAVCAN](#1-uavcan-interface)
  - [2. Спецификация оборудования](#2-hardware-specification)
  - [3. Подключение](#3-wire)
  - [4. Описание основных функций](#4-main-function-description)
  - [- 4.1. Описание параметров](#41-params-description)
  - [- 4.2. Алгоритм измерения оборотов](#42-rpm-measurement-algorithm)
  - [- 4.3. Алгоритм управления двигателем](#43-engine-controlling-algorithm)
  - [5. Описание вспомогательных функций](#5-auxiliary-function-description)
  - [6. Светодиодная индикация](#6-led-indication)
  - [7. Пример использования на стенде](#7-usage-example-on-a-table)
  - [8. Пример использования в БПЛА](#8-uav-usage-example)

## 1. Интерфейс UAVCAN <a name="1-uavcan-interface"></a> 

Этот узел взаимодействует со следующими сообщениями:

| № | тип | сообщение |
| - | --------- | -------- |
| 1 | subscriber | [uavcan.equipment.esc.RawCommand](https://dronecan.github.io/Specification/7._List_of_standard_data_types/#rawcommand)|
| 2 | publisher | [uavcan.equipment.ice.reciprocating.Status](https://dronecan.github.io/Specification/7._List_of_standard_data_types/#status-4) |
| 3 | publisher | [uavcan.equipment.ice.FuelTankStatus](https://dronecan.github.io/Specification/7._List_of_standard_data_types/#fueltankstatus)| |

Помимо необходимых и очень рекомендуемых функций, таких как `NodeStatus` и `GetNodeInfo`, этот узел также поддерживает следующие функции прикладного уровня:

| № | тип | сообщение |
| - | --------- | -------- |
| 1 | RPC-service | [uavcan.protocol.param](https://dronecan.github.io/Specification/7._List_of_standard_data_types/#uavcanprotocolparam)|
| 2 | RPC-service | [uavcan.protocol.RestartNode](https://dronecan.github.io/Specification/7._List_of_standard_data_types/#restartnode)|
| 3 | RPC-service | [uavcan.protocol.GetTransportStats](https://dronecan.github.io/Specification/7._List_of_standard_data_types/#gettransportstats) |

## 2. Спецификация оборудования <a name="2-hardware-specification"></a> 

(в процессе)

## 3. Подключение <a name="3-wire"></a> 

**CAN-интерфейс**

На плате имеется 4 разъема, с помощью которых она может быть запитана. Их описание преставлено в таблице ниже.

| № | Разъем | Описание |
| - | --------- | ----------- |
| 1 | Power socket | Данная плата потребляет больше, чем другие. Рекомендуется питать ее с данного разъема, иначе некоторый функционал может быть не доступен. |
| 2 | UCANPHY Micro (JST-GH 4) | Примечание спецификации физического уровня UAVCAN/CAN. Устройства, подающие питание на шину, должны обеспечивать 4,9-5,5 В на линии питания шины, номинальное напряжение 5,0 В. Устройства, получающие питание от шины, должны ожидать 4,0-5,5 В на линии питания шины. Ток не должен превышать 1 А на каждый разъем. |
| 3 | 6-контактный разъем Molex серии 502585 ([502585-0670](https://www.molex.com/molex/products/part-detail/pcb_receptacles/5025850670) и [502578-0600](https://www.molex.com/molex/products/part-detail/crimp_housings/5025780600)) | Разъем поддерживает до 100 В, 2 A на контакт, но плата работает только с 2S-6S. |
| 4 | SWD | Предназначен для обновления прошивки с помощью устройства [programmer-sniffer](docs/guide/programmer_sniffer/README.md). |

Также на плате есть следующие разъемы:

| № | Разъем           | Описание       |
| - | ---------------- | -------------- |
| 5 | Fuel tank sensor | in process...  |
| 6 | Starter          | in process...  |
| 7 | Spark ignition   | in process...  |
| 8 | Throttle         | in process...  |


## 4. Описание основных функций <a name="4-main-function-description"></a> 

### 4.1. Описание параметров  <a name="41-params-description"></a> 

Ниже приведен список существующих параметров.

![parameters](parameters.png?raw=true "parameters")

В таблицах ниже вы можете увидеть подробное описание таких параметров.

**Параметры топливного бака**

| № | Имя параметра | Описание |
| - | ------------------- | ------------ |
| 1 | fuel_tank_pub_period | Период между публикацией сообщения о топливном баке |
| 2 | fuel_tank_pub_min_press | Калибровочное значение дифф. давления, соответствующее 0% топливного бака | |
| 3 | fuel_tank_pub_max_press | Калибровочное значение дифф. давления соответствует 100% топливного бака | | 3 | fuel_tank_pub_max_press | Калибровочное значение дифф. давления, соответствующее 100% топливного бака.

**Параметры зажигания**

| № | Название параметра | Описание |
| - | ---------------------- | ------------ |
| 4 | spark_ignition_offset | Если команда raw больше этого значения, то зажигание будет включено, в противном случае - выключено |
| 5 | spark_ignition_ch/mode | Индекс канала RawCommand; -1 означает отключение этой функции | 
| 6 | spark_ignition_min | Deprecated. Длительность Pwm соответствует выключенному состоянию.  | 
| 7 | spark_ignition_max | Deprecated. Длительность Pwm соответствует включенному состоянию  | 
| 7 | spark_ignition_design_max | Deprecated| 
| 8 | spark_ignition_default | Deprecated Длительность Pwm соответствует состоянию, когда последние полсекунды нет RawCommand | 

**Параметры стартера**

| № | Имя параметра | Описание |
| - | ----------------------------- | ------------ |
| 9 | starter_offset | Если raw-команда больше этого значения, зажигание будет включено, в противном случае выключено |
| 10| starter_ch/mode | Индекс канала RawCommand; -1 означает отключение этой функции |
| 11| starter_min_rpm_treshold | Стартер может быть включен только если обороты меньше этого значения |
| 12| starter_max_rpm_treshold | Deprecated |
| 13| starter_try_duration | Параметр алгоритма стартера, описывает период, в течение которого стартер будет пытаться запустить двигатель
| 14| starter_delay_before_next_try | Параметр алгоритма стартера, описывает период, в течение которого стартер будет ждать перед следующей попыткой |

**Параметры публикации состояния ESC**
| № | Имя параметра | Описание |
| - | -------------- | ------------ |
| 15| esc_pub_period | Период между публикациями EscStatus. В нем содержится информация о напряжении и токе стартера |
| 16| esc_index | Индекс соответствующего сообщения EscStatus; -1 означает отключение публикации |

**Дроссель**
| № | Имя параметра | Описание |
| - | ---------------- | ------------ |
| 17| throttle_ch/mode | Индекс канала RawCommand; -1 означает отключение этой функции |
| 18| throttle_min | Длительность Pwm, соответствующая RawCommand=0 |
| 19| throttle_max | Длительность Pwm, соответствующая RawCommand=8191 | 
| 20| throttle_default | Длительность Pwm соответствует RawCommand < 0 или когда RawCommand отсутствует последние полсекунды |

### 4.2. Алгоритм измерения оборотов <a name="42-rpm-measurement-algorithm"></a> 

Реализовано 2 типа алгоритмов измерения оборотов и фильтрации.



```
Старый алгоритм:
Используя прерывания и захват входа, запоминает время, когда были захвачены последний и предыдущий импульсы.
Каждые 10 мс он вычисляет частоту импульсов, используя текущее и предыдущее время, и помещает это значение в некоторый кольцевой буфер размером 20.
Каждые 100 мс он получает медианное значение из этого буфера и публикует `esc_status` uavcan msg. Эта частота и `esc index` могут быть изменены с помощью параметров.
```

### 4.3. Алгоритм управления двигателем <a name="43-engine-controlling-algorithm"></a> 

Для управления двигателем используются `стартер`, `зажигание` и `дроссель`. Все они используют `RawCommand` в качестве управляющего входа.

1. Состояние дроссельной заслонки напрямую управляется командой RawCommand. Это означает, что значение входной команды один к одному отображается на длительность pwm. Нижняя и верхняя границы длительности определены в соответствующих параметрах.
2. Зажигание двигателя имеет 2 состояния. Когда оно включено, оно имеет максимальную длительность pwm, в противном случае оно имеет минимальную длительность. Значение RawCommand соответствующего канала больше некоторого смещения означает, что зажигание включено. Смещение можно задать в параметрах.
3. Стартер имеет 2 состояния, как и зажигание, но логика немного отличается. Если значение входного канала больше смещения, то будет произведена попытка запустить двигатель с продолжительностью до определенного времени. Если попытка не удалась, он выключится на определенное время (чтобы сигнализировать о неудаче), а затем повторит попытку. Если медианная скорость за последнюю секунду больше некоторого определенного значения, попытка будет прекращена. Длительность и смещение могут быть заданы в параметрах.

В любом случае, если последняя RawCommand с соответствующим значением канала была получена более 2 секунд назад, все состояния управляемых устройств будут переведены в состояние по умолчанию.

## 5. Описание вспомогательных функций <a name="5-auxiliary-function-description"></a> 

(в процессе)

## 6. Светодиодная индикация <a name="6-led-indication"></a> 

- когда стартер включен, светодиод горит
- когда стартер отключен, светодиод выключен

## 7. Пример использования на стенде <a name="7-usage-example-on-a-table"></a> 

(в процессе)

## 8. Пример использования в БПЛА <a name="8-uav-usage-example"></a> 

Этот узел был успешно протестирован на VTOL-самолёте. Вот пример значений RPM и RawCommand, собранных из одного из журналов полета.
